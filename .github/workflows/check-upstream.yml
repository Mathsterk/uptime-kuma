name: Check upstream for changes

on:
  schedule:
    - cron: '43 17 * * *'
  workflow_dispatch:

jobs:
  check-changes:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout current repo
        uses: actions/checkout@v4
        with:
          path: main

      - name: Checkout upstream
        uses: actions/checkout@v4
        with:
          repository: louislam/uptime-kuma
          path: upstream

      - name: Retrieve last commit
        run: |
          echo MAIN=$(main/.last-upstream-commit) >> $GITHUB_ENV

      - name: Retrieve HEAD commit of upstream
        run: |
          echo UPSTREAM=$(git -C upstream rev-parse --verify HEAD) >> $GITHUB_ENV

      - name: Make file with last commit
        if: env.MAIN != env.UPSTREAM
        run: |
          echo $UPSTREAM > main/.last-upstream-commit

      - name: Make PR
        uses: peter-evans/create-pull-request@153407881ec5c347639a548ade7d8ad1d6740e38
        if: env.MAIN != env.UPSTREAM
        with:
          path: main
          title: ${{ env.UPSTREAM }}
